.. _ref-dev-checklist:

POD development checklist
=========================

In this section, we compile a to-do list summarizing necessary steps for POD implementation, as well as a checklist for mandatory POD documentation and testing before submitting your POD.



To-do list for POD implementation
---------------------------------

The following are the necessary steps for the POD module implementation and integration into the framework. You can use the PODs currently included in the code package under ``diagnostics/`` as concrete examples since they all have the same structure as described below:

1. Create your POD directory under ``diagnostics/`` and put all scripts in. Among the scripts, there should be 1) a main driver script, 2) a template html, and 3) a ``settings.jsonc`` file. The POD directory, driver script, and html template should all be named after your POD's short name.

   - For instance, ``diagnostics/convective_transition_diag/`` contains its driver script ``convective_transition_diag.py``, ``convective_transition_diag.html``, and ``settings.jsonc``, etc.

   - The framework will call the driver script, which calls the other scripts in the same POD directory.

   - The html template will be copied by the framework into the output directory to display the figures generated by the POD. You should be able to create a new html template by simply copying and modifying the example templates from existing PODs even without prior knowledge about html syntax.

   - ``settings.jsonc`` contains a POD's information. The framework will read this setting file to find out the driver script's name, verify the required environment and model data files are available, and prepare the necessary environment variables before executing the driver script.

2. Create a directory under ``inputdata/obs_data/`` named after the short name, and put all your *digested* observation data in (or more generally, any quantities that are independent of the model being analyzed).

   - Digested data should be in the form of numerical data, not figures.

   - Raw data, e.g., undigested reanalysis data will be rejected.

   - The data files should be small (preferably a few MB) and just enough for producing figures for model comparison.

   - If you really cannot reduce the data size or require GB of space, consult with the lead team.

3. Provide the Conda environment your POD requires. Either you can use one of the Conda environments currently supplied with the framework, defined by the YAML (.yml) files in ``src/conda/``, or submit a .yml file for a new environment.

   - We recommend using existing Conda environments as much as possible. Consult with the lead team if you would like to submit a new one.

   - If you need a new Conda environment, add a new .yml file to ``src/conda/``, and install the environment using the ``conda_env_setup.sh`` script as described in the :doc:`Getting Started <start_install>`.

4. If your POD requires model data not included in the samples, prepare your own data files following instructions given in the :doc:`Getting Started <start_config>`, and create a new configuration input from the template ``src/default_tests.jsonc``.

Update ``case_list`` and ``pod_list`` in the configuration input file for your POD. Now you can try to run the framework following the :doc:`Getting Started <start_install>` and start debugging. Good luck!

.. _ref-checklist:

Checklist before submitting your POD
------------------------------------

After getting your POD working under the framework, there are 2 additional steps regarding the mandatory POD documentation and testing before you can submit your work to the lead team.

4. Provide documentation following the templates:

   A. Provide a comprehensive POD documentation in reStructuredText (.rst) format. This should include a one-paragraph synopsis of the POD, developers’ contact information, required programming language and libraries, and model output variables, a brief summary of the presented diagnostics as well as references in which more in-depth discussions can be found.

      - Create a ``doc`` directory under your POD directory (e.g., ``diagnostics/convective_transition_diag/doc/``) and put the .rst file and figures inside. It should be easy to copy and modify the .rst examples from existing PODs.

   B. All scripts should be self-documenting by including in-line comments. The main driver script (e.g., ``convective_transition_diag.py``) should contain a comprehensive header providing information that contains the same items as in the POD documentation, except for the "More about this diagnostic" section.

   C. The one-paragraph POD synopsis (in the POD documentation) as well as a link to the Full Documentation should be placed at the top of the html template (e.g., ``convective_transition_diag.html``).

5. Test before distribution. It is important that you test your POD before sending it to the lead team contact. Please take the time to go through the following procedures:

   A. Test how the POD fails. Does it stop with clear errors if it doesn’t find the files it needs? How about if the dates requested are not presented in the model data? Can developers run it on data from another model? Here are some simple tests you should try:

      - Move the ``inputdata`` directory around. Your POD should still work by simply updating the values of ``OBS_DATA_ROOT`` and ``MODEL_DATA_ROOT`` in the configuration input file.

      - Try to run your POD with a different set of model data. For POD development and testing, the MDTF-1 team produced the Timeslice Experiments output from the `NCAR CAM5 <https://www.earthsystemgrid.org/dataset/ucar.cgd.ccsm4.NOAA-MDTF.html>`__ and `GFDL AM4 (contact the lead team for password) <http://data1.gfdl.noaa.gov/MDTF/>`__.

      - If you have problems getting another set of data, try changing the files' ``CASENAME`` and variable naming convention. The POD should work by updating ``CASENAME`` and ``convention`` in the configuration input.

      - Try your POD on a different machine. Check that your POD can work with reasonable machine configuration and computation power, e.g., can run on a machine with 32 GB memory, and can finish computation in 10 min. Will memory and run time become a problem if one tries your POD on model output of high spatial resolution and temporal frequency (e.g., avoid memory problem by reading in data in segments)? Does it depend on a particular version of a certain library? Consult the lead team if there's any unsolvable problems.

   B. After you have tested your POD thoroughly, make clean tar files for distribution. Make a tar file of your digested observational data (preserving the ``inputdata/obs_data/`` structure). Do the same for model data used for testing (if different from what is provided by the MDTF page). Upload your POD code to your :doc:`GitHub repo <dev_git_intro>`. The tar files (and your GitHub repo) should not include any extraneous files (backups, ``pyc``, ``*~``, or ``#`` files).

      - Use ``tar -tf`` to see what is in the tar file.

   C. β-test before distribution. Find people (β-testers) who are not involved in your POD's implementation and are willing to help. Give the tar files and point your GitHub repo to them. Ask them to try running the framework with your POD following the Getting Started instructions. Ask for comments on whether they can understand the documentation.

      - Possible β-tester candidates include nearby postdocs/grads and members from other POD-developing groups.

6. Submit your POD code through :doc:`GitHub pull request <dev_git_intro>`, and share the tar files of digested observation (and model data if any) with the lead-team contact. Please also provide a list of tests you've conducted along with the machine configurations (e.g., memory size).
